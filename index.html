<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/sample.css">
    <title>Jank</title>
</head>

<body>
    <header>
        <h1>Jank</h1>
    </header>

    <main>
        <ul class='mainBtn'>
            <li id="gu_btn">グー</li>
            <li id="cho_btn">チョキ</li>
            <li id="par_btn">パー</li>
            <li id="auto_btn">オート</li>
        </ul>

        <div class='simpleJankenArea'>
            <div>勝敗</div>
            <div id="judgment"></div>
        </div>

        <div class='resultArea'>
            <table class='myResultArea'>
                <tr>
                    <td>自分の手</td>
                    <td class='myResultNoArea' id="jibun"></td>
                </tr>
                <tr>
                    <td>グー数</td>
                    <td class='myResultNoArea' id="my_numOfHandKind_Gu_ID">0</td>
                </tr>
                <tr>
                    <td>チョキ数</td>
                    <td class='myResultNoArea' id="my_numOfHandKind_Choki_ID">0</td>
                </tr>
                <tr>
                    <td>パー数</td>
                    <td class='myResultNoArea' id="my_numOfHandKind_Par_ID">0</td>
                </tr>
                <tr>
                    <td>勝ち数</td>
                    <td class='myResultNoArea' id="my_numOfJudge_Win_ID">0</td>
                </tr>
                <tr>
                    <td>負け数</td>
                    <td class='myResultNoArea' id="my_numOfJudge_Loss_ID">0</td>
                </tr>
                <tr>
                    <td>あいこ数</td>
                    <td class='myResultNoArea' id="my_numOfJudge_Even_ID">0</td>
                </tr>
                <tr>
                    <td>直近コンボ</td>
                    <td class='myResultNoArea' id="my_numOfLastCombo_ID">0</td>
                </tr>
                <tr>
                    <td>最大コンボ</td>
                    <td class='myResultNoArea' id="my_numOfMaxCombo_ID">0</td>
                </tr>
                <tr>
                    <td>ポイント</td>
                    <td class='myResultNoArea' id="my_nomalPoint_ID">0</td>
                </tr>
                <tr>
                    <td>コンボボーナス</td>
                    <td class='myResultNoArea' id="my_comboPoint_ID">0</td>
                </tr>
                <tr>
                    <td>合計ポイント</td>
                    <td class='myResultNoArea' id="my_pointSum_ID">0</td>
                </tr>
            </table>

            <div class r='esultGraph'>
                <div class='resultGraphArea'>自分グラフ
                    <canvas id="myChart"></canvas>
                </div>
            </div>

            <table class='resultTxtArea'>
                <tr>
                    <td class='yourResultNoArea' id="aite"></td>
                    <td class='yourResultTxtArea'>相手の手</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfHandKind_Gu_ID">0</td>
                    <td class='yourResultTxtArea'>グー数</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfHandKind_Choki_ID">0</td>
                    <td class='yourResultTxtArea'>チョキ数</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfHandKind_Par_ID">0</td>
                    <td class='yourResultTxtArea'>パー数</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfJudge_Win_ID">0</td>
                    <td class='yourResultTxtArea'>勝ち数</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfJudge_Loss_ID">0</td>
                    <td class='yourResultTxtArea'>負け数</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfJudge_Even_ID">0</td>
                    <td class='yourResultTxtArea'>あいこ数</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfLastCombo_ID">0</td>
                    <td class='yourResultTxtArea'>直近コンボ</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_numOfMaxCombo_ID">0</td>
                    <td class='yourResultTxtArea'>最大コンボ</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_nomalPoint_ID">0</td>
                    <td class='yourResultTxtArea'>ポイント</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_comboPoint_ID">0</td>
                    <td class='yourResultTxtArea'>コンボボーナス</td>
                </tr>
                <tr>
                    <td class='yourResultNoArea' id="your_pointSum_ID">0</td>
                    <td class='yourResultTxtArea'>ポイント合計</td>
                </tr>
            </table>


    </main>

    <footer></footer>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>

    <script>
        /********************************
         * 定数定義
         ********************************/

        // グーチョキパー
        const JANKEN_HAND_GU = 0;
        const JANKEN_HAND_CHOKI = 1;
        const JANKEN_HAND_PAR = 2;

        // 文字列変換表
        const JANKEN_HAND_TEXT_MTX = [
            'グー',
            'チョキ',
            'パー'
        ];

        //勝ち負けあいこ
        const JANKEN_JUDGE_WIN = 0;
        const JANKEN_JUDGE_LOSS = 1;
        const JANKEN_JUDGE_DRAW = 2;

        // 文字列変換表
        const JANKEN_JUDGE_TEXT_MTX = [
            'かち',
            'まけ',
            'あいこ'
        ];

        // 勝ち負け判定マトリックス
        // 1次元目:自分の手  2次元目:相手の手
        const JANKEN_JUDGE_MTX = [
            // 相手がグー,チョキ,パー
            [JANKEN_JUDGE_DRAW, JANKEN_JUDGE_WIN, JANKEN_JUDGE_LOSS],   //自分がグー
            [JANKEN_JUDGE_LOSS, JANKEN_JUDGE_DRAW, JANKEN_JUDGE_WIN],   //自分がチョキ
            [JANKEN_JUDGE_WIN, JANKEN_JUDGE_LOSS, JANKEN_JUDGE_DRAW]    //自分がパー
        ];

        //IDの連想配列
        const ID_TO_JANKEN_HAND = {
            // なぜか直打ちじゃないと動かない
            '#gu_btn': JANKEN_HAND_GU,
            '#cho_btn': JANKEN_HAND_CHOKI,
            '#par_btn': JANKEN_HAND_PAR
        };
        //乱数のパラメータ
        const min = 0;
        const max = 2;
    </script>

    <script>
        /********************************
         * グラフを書く
         ********************************/
        var ctx = document.getElementById('myChart').getContext('2d');
        var chart = new Chart(ctx, {
            // 作成したいチャートのタイプ
            type: 'bar',

            // データセットのデータ
            data: {
                labels: ["グー", "チョキ", "パー", "勝ち", "負け", "あいこ", "PT", "CMB", "SUM"],
                datasets: [
                    {
                        label: "自分",
                        backgroundColor: 'rgb(00, 128, 00)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                    }, {
                        label: "相手",
                        backgroundColor: 'rgb(255, 0, 132)',
                        borderColor: 'rgb(255, 0, 132)',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                    }
                ]
            },

            // ここに設定オプションを書きます
            options: {}
        });
    </script>

    <script>
        /********************************
         * 共通関数
         ********************************/

        /********************************
         * スリープ関数
         * @param in ms  ミリセカンド
         ********************************/
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /********************************
         * 自分の手の表記を変える関数
         * @param in inputId  ジャンケンの手
         * @param in outputId 書き変える対象のID
         ********************************/
        function jibunIdToJankenHand(jankenHand, outputId) {
            let jankenTxt = JANKEN_HAND_TEXT_MTX[jankenHand]    //入力されたジャンケンの数値をテキストに変える
            $(outputId).text(jankenTxt);
            return;
        }

        /********************************
         * 相手の手の表記を変える関数
         * @param in jankenHand  ジャンケンの手
         * @param in outputId 書き変える対象のID
         ********************************/
        function aiteIdToJankenHand(jankenHand, outputId) {
            let jankenTxt = JANKEN_HAND_TEXT_MTX[jankenHand]    //入力されたジャンケンの数値をテキストに変える
            $(outputId).text(jankenTxt);
            return;
        }

    </script>

    <script>
        /********************************
         * オート機能
         ********************************/
        $(function () {
            $('#auto_btn').on('click', function () {


                //自分用集計データ
                let my_numOfHandKind = [0, 0, 0];    //グー、チョキ、パーを出した数
                let my_numOfJudge = [0, 0, 0];       //勝ち、負け、あいこになった数
                let my_numOfLastCombo = 0;           //直近の連勝数
                let my_numOfMaxCombo = 0;            //最大連勝数
                let my_nomalPoint = 0;               //通常ポイント
                let my_comboPoint = 0;               //連勝ポイント

                //相手用集計データ
                let your_numOfHandKind = [0, 0, 0];  //グー、チョキ、パーを出した数
                let your_numOfJudge = [0, 0, 0];     //勝ち、負け、あいこになった数
                let your_numOfLastCombo = 0;         //直近の連勝数
                let your_numOfMaxCombo = 0;          //最大連勝数
                let your_nomalPoint = 0;             //通常ポイント
                let your_comboPoint = 0;             //連勝ポイント

                //クリックされたIDを求める
                clickID = '#' + $(this).attr("id");
                //デバッグ出力
                console.log('id  ' + clickID);

                //自動でジャンケンを繰り返す
                (async () => {
                    //デバッグ出力
                    for (let i = 0; i < 100; i++) {

                        //0-2の乱数をJANKEN_HANDとし、それをもとに自分の出した手の表記を変える
                        let myHand = Math.floor(Math.random() * (max - min + 1)) + min;
                        jibunIdToJankenHand(myHand, '#jibun');

                        //0-2の乱数をJANKEN_HANDとし、それをもとに相手の出した手の表記を変える
                        let yourHand = Math.floor(Math.random() * (max - min + 1)) + min;
                        aiteIdToJankenHand(yourHand, '#aite')

                        //勝敗判定
                        let myJudeCode = JANKEN_JUDGE_MTX[myHand][yourHand];
                        let myJudge = JANKEN_JUDGE_TEXT_MTX[myJudeCode];
                        let yourJudgeCode = JANKEN_JUDGE_MTX[yourHand][myHand];
                        let yourJudge = JANKEN_JUDGE_TEXT_MTX[yourJudgeCode];
                        $('#judgment').text(myJudge);

                        //自分用集計データ
                        my_numOfHandKind[myHand] += 1;    //グー、チョキ、パーを出した数
                        my_numOfJudge[myJudeCode] += 1;      //勝ち、負け、あいこになった数

                        //勝ちの場合の一連の処理
                        if (myJudeCode == JANKEN_JUDGE_WIN) {

                            //直近連勝数を更新し直近連勝数が最大連勝数を超えるようなら
                            //最大連勝数の更新
                            my_numOfLastCombo += 1;
                            if (my_numOfLastCombo > my_numOfMaxCombo) {
                                my_numOfMaxCombo = my_numOfLastCombo;
                            }
                            //通常ポイントアップ
                            my_nomalPoint += 1;
                            //連勝ポイントアップ
                            if (my_numOfLastCombo > 1) {
                                // my_comboPoint += my_numOfLastCombo;
                                my_comboPoint += 1;
                            }

                        }
                        //負けの場合の一連の処理
                        else if (myJudeCode == JANKEN_JUDGE_LOSS) {
                            //直近連勝数のリセット
                            my_numOfLastCombo = 0;
                        }

                        //相手用集計データ
                        your_numOfHandKind[yourHand] += 1;    //グー、チョキ、パーを出した数
                        your_numOfJudge[yourJudgeCode] += 1;      //勝ち、負け、あいこになった数

                        //勝ちの場合の一連の処理
                        if (yourJudgeCode == JANKEN_JUDGE_WIN) {
                            //直近連勝数を更新し直近連勝数が最大連勝数を超えるようなら
                            //最大連勝数の更新
                            your_numOfLastCombo += 1;
                            if (your_numOfLastCombo > your_numOfMaxCombo) {
                                your_numOfMaxCombo = your_numOfLastCombo;
                            }
                            //通常ポイントアップ
                            your_nomalPoint += 1;
                            //連勝ポイントアップ
                            if (your_numOfLastCombo > 1) {
                                // your_comboPoint += your_numOfLastCombo;
                                your_comboPoint += 1;
                            }
                        }
                        //負けの場合の一連の処理
                        else if (yourJudgeCode == JANKEN_JUDGE_LOSS) {
                            //直近連勝数のリセット
                            your_numOfLastCombo = 0;
                        }

                        //結果の更新
                        $(my_numOfHandKind_Gu_ID).text(my_numOfHandKind[JANKEN_HAND_GU]);
                        $(my_numOfHandKind_Par_ID).text(my_numOfHandKind[JANKEN_HAND_CHOKI]);
                        $(my_numOfHandKind_Choki_ID).text(my_numOfHandKind[JANKEN_HAND_PAR]);
                        $(my_numOfJudge_Win_ID).text(my_numOfJudge[JANKEN_JUDGE_WIN]);
                        $(my_numOfJudge_Loss_ID).text(my_numOfJudge[JANKEN_JUDGE_LOSS]);
                        $(my_numOfJudge_Even_ID).text(my_numOfJudge[JANKEN_JUDGE_DRAW]);
                        $(my_numOfLastCombo_ID).text(my_numOfLastCombo);
                        $(my_numOfMaxCombo_ID).text(my_numOfMaxCombo);
                        $(my_nomalPoint_ID).text(my_nomalPoint);
                        $(my_comboPoint_ID).text(my_comboPoint);
                        $(my_pointSum_ID).text(my_nomalPoint + my_comboPoint);

                        $(your_numOfHandKind_Gu_ID).text(your_numOfHandKind[JANKEN_HAND_GU]);
                        $(your_numOfHandKind_Par_ID).text(your_numOfHandKind[JANKEN_HAND_CHOKI]);
                        $(your_numOfHandKind_Choki_ID).text(your_numOfHandKind[JANKEN_HAND_PAR]);
                        $(your_numOfJudge_Win_ID).text(your_numOfJudge[JANKEN_JUDGE_WIN]);
                        $(your_numOfJudge_Loss_ID).text(your_numOfJudge[JANKEN_JUDGE_LOSS]);
                        $(your_numOfJudge_Even_ID).text(your_numOfJudge[JANKEN_JUDGE_DRAW]);
                        $(your_numOfLastCombo_ID).text(your_numOfLastCombo);
                        $(your_numOfMaxCombo_ID).text(your_numOfMaxCombo);
                        $(your_nomalPoint_ID).text(your_nomalPoint);
                        $(your_comboPoint_ID).text(your_comboPoint);
                        $(your_pointSum_ID).text(your_nomalPoint + your_comboPoint);

                        //グラフの更新
                        chart.data.datasets[0].data[0] = my_numOfHandKind[JANKEN_HAND_GU];
                        chart.data.datasets[0].data[1] = my_numOfHandKind[JANKEN_HAND_CHOKI];
                        chart.data.datasets[0].data[2] = my_numOfHandKind[JANKEN_HAND_PAR];
                        chart.data.datasets[0].data[3] = my_numOfJudge[JANKEN_JUDGE_WIN];
                        chart.data.datasets[0].data[4] = my_numOfJudge[JANKEN_JUDGE_LOSS];
                        chart.data.datasets[0].data[5] = my_numOfJudge[JANKEN_JUDGE_DRAW];
                        chart.data.datasets[0].data[6] = my_nomalPoint;
                        chart.data.datasets[0].data[7] = my_comboPoint;
                        chart.data.datasets[0].data[8] = my_nomalPoint + my_comboPoint;

                        chart.data.datasets[1].data[0] = your_numOfHandKind[JANKEN_HAND_GU];
                        chart.data.datasets[1].data[1] = your_numOfHandKind[JANKEN_HAND_CHOKI];
                        chart.data.datasets[1].data[2] = your_numOfHandKind[JANKEN_HAND_PAR];
                        chart.data.datasets[1].data[3] = your_numOfJudge[JANKEN_JUDGE_WIN];
                        chart.data.datasets[1].data[4] = your_numOfJudge[JANKEN_JUDGE_LOSS];
                        chart.data.datasets[1].data[5] = your_numOfJudge[JANKEN_JUDGE_DRAW];
                        chart.data.datasets[1].data[6] = your_nomalPoint;
                        chart.data.datasets[1].data[7] = your_comboPoint;
                        chart.data.datasets[1].data[8] = your_nomalPoint + your_comboPoint;

                        chart.update();


                        //オート間隔
                        await sleep(100);

                    }
                })();
            });
        });
    </script>


    <script>
        /********************************
         * シンプル機能
         ********************************/
        $(function () {
            /********************************
             * ジャンケン機能 メイン
             ********************************/
            //三つ同時に判定
            $('#gu_btn, #cho_btn, #par_btn').on('click', function () {

                //クリックされたIDを求める
                let clickID = '#' + $(this).attr("id");
                //デバッグ出力
                console.log('id  ' + clickID);

                //クリックされたIDをJANKEN_HANDとし、それをもとに自分の出した手の表記を変える
                let myHand = ID_TO_JANKEN_HAND[clickID];
                jibunIdToJankenHand(myHand, '#jibun');

                //0-2の乱数をJANKEN_HANDとし、それをもとに相手の出した手の表記を変える
                let yourHand = Math.floor(Math.random() * (max - min + 1)) + min;
                aiteIdToJankenHand(yourHand, '#aite')

                //勝敗判定
                let judge = JANKEN_JUDGE_TEXT_MTX[JANKEN_JUDGE_MTX[myHand][yourHand]];
                $('#judgment').text(judge);

            })
        });
    </script>

</body>

</html>